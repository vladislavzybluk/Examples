SELECT t.user_id,
       date_trunc('month', t.date) AS month,
       sum(t.payout) AS payout,
       sum(t.fee) AS fee,
       sum(t.tax) AS tax,
       sum(t.total_amount) AS total_amount
FROM (
SELECT t.user_id,
       t.date,
       (select sum(ti2.amount)
        FROM transaction_items ti2
        WHERE ti2.transaction_id = t.id AND ti2.type = 100) AS payout,
       (select sum(ti2.amount)
        FROM transaction_items ti2
        where ti2.transaction_id = t.id AND ti2.type = 23) AS fee,
       (select sum(ti2.amount)
        FROM transaction_items ti2
        WHERE ti2.transaction_id = t.id AND ti2.type = 25) AS tax,
       sum(ti.amount) AS total_amount
FROM transactions t
         join transaction_items ti ON ti.transaction_id = t.id
WHERE t.user_id = 879
  AND t.type = 23
GROUP BY t.id, t.user_id) t
GROUP BY t.user_id, date_trunc('month', t.date)
GROUP BY date_trunc('month', t.date) DESC
